<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Bot Enhanced - Teste Account/Contact</title>

    <style type="text/css">
        body {
            font-family: "Salesforce Sans", Arial, sans-serif;
            margin: 20px;
        }

        h2 {
            color: #EB640A;
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: 600;
        }

        input[type="text"] {
            width: 400px;
            max-width: 100%;
            padding: 6px 8px;
            margin-top: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button#startChatButton {
            margin-top: 16px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #EB640A;
            color: #FFFFFF;
            font-weight: 600;
            cursor: pointer;
        }

        button#startChatButton:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status {
            margin-top: 12px;
            font-size: 0.9rem;
            color: #555;
        }

        .embeddedServiceHelpButton .helpButton .uiButton {
            background-color: #EB640A;
            font-family: "Salesforce Sans", sans-serif;
        }
        .embeddedServiceHelpButton .helpButton .uiButton:focus {
            outline: 1px solid #EB640A;
        }

        @font-face {
            font-family: "Salesforce Sans";
            src: url("https://c1.sfdcstatic.com/etc/clientlibs/sfdc-aem-master/clientlibs_base/fonts/SalesforceSans-Regular.woff") format("woff"),
                 url("https://c1.sfdcstatic.com/etc/clientlibs/sfdc-aem-master/clientlibs_base/fonts/SalesforceSans-Regular.ttf") format("truetype");
        }
    </style>
</head>
<body>
    <h2>Teste do Bras Enhanced (AccountId / ContactId)</h2>

    <form id="prechatForm" onsubmit="event.preventDefault(); startChatWithPrechat();">
        <label for="accountId">Account Id</label>
        <input type="text" id="accountId" placeholder="001XXXXXXXXXXXX" value="0018900000WyW8PAAV" />

        <label for="contactId">Contact Id</label>
        <input type="text" id="contactId" placeholder="003XXXXXXXXXXXX" value="0038900000OCz1uAAD" />

        <button type="submit" id="startChatButton" disabled>
            Iniciar chat com esses dados
        </button>
    </form>

    <div class="status" id="statusMessage">
        Carregando script do Salesforce...
    </div>

    <script type="text/javascript">
        let messagingReady = false;

        // Evento disparado pelo bootstrap do Embedded Messaging
        window.addEventListener("onEmbeddedMessagingReady", () => {
            messagingReady = true;
            document.getElementById("statusMessage").textContent =
                "Embedded Messaging carregado. Você já pode iniciar o chat.";

            const btn = document.getElementById("startChatButton");
            if (btn) {
                btn.disabled = false;
            }
        });

        function startChatWithPrechat() {
            if (!messagingReady || !window.embeddedservice_bootstrap) {
                alert("O cliente de messaging ainda não está pronto. Tente novamente em alguns segundos.");
                return;
            }

            // Lê dos inputs (ou usa valores fixos, se quiser)
            let accountId = document.getElementById("accountId").value.trim();
            let contactId = document.getElementById("contactId").value.trim();

            const hiddenFields = {};

            // Nomes EXATOS das variáveis criadas no Messaging Channel:
            // AccountId e ContactId
            if (accountId) {
                hiddenFields["AccountId"] = {
                    value: accountId,
                    isEditableByEndUser: false
                };
            }

            if (contactId) {
                hiddenFields["ContactId"] = {
                    value: contactId,
                    isEditableByEndUser: false
                };
            }

            if (Object.keys(hiddenFields).length === 0) {
                alert("Preencha pelo menos AccountId ou ContactId antes de iniciar o chat.");
                return;
            }

            try {
                embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields(hiddenFields);
                console.log("Hidden pre-chat fields enviados:", hiddenFields);
            } catch (e) {
                console.error("Erro ao enviar hidden pre-chat fields:", e);
                alert("Erro ao enviar dados de pre-chat. Veja o console do navegador.");
                return;
            }

            embeddedservice_bootstrap.utilAPI
                .launchChat()
                .then(() => {
                    console.log("Chat lançado com sucesso.");
                })
                .catch((err) => {
                    console.error("Erro ao lançar o chat:", err);
                    alert("Falha ao iniciar o chat. Veja o console do navegador.");
                });
        }

        function initEmbeddedMessaging() {
            try {
                embeddedservice_bootstrap.settings.language = "pt_BR";

                embeddedservice_bootstrap.init(
                    "00D890000032JqX", // Org Id (sandbox)
                    "Bras_CanaisDigitaisEnhanced", // Dev name do deployment
                    "https://supergasbras--tecnica25.sandbox.my.site.com/ESWBrasCanaisDigitais1764590606132",
                    {
                        scrt2URL: "https://supergasbras--tecnica25.sandbox.my.salesforce-scrt.com"
                    }
                );
            } catch (err) {
                console.error("Error loading Embedded Messaging: ", err);
                document.getElementById("statusMessage").textContent =
                    "Erro ao carregar Embedded Messaging. Veja o console do navegador.";
            }
        }
    </script>

    <script
        type="text/javascript"
        src="https://supergasbras--tecnica25.sandbox.my.site.com/ESWBrasCanaisDigitais1764590606132/assets/js/bootstrap.min.js"
        onload="initEmbeddedMessaging()">
    </script>
</body>
</html>
